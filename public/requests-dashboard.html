<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Nhu cáº§u ÄÃ o táº¡o | Quáº£n lÃ½ yÃªu cáº§u ATLÄ | ATLÄ Connect</title>
    <meta name="description" content="Quáº£n lÃ½ vÃ  theo dÃµi cÃ¡c nhu cáº§u Ä‘Ã o táº¡o an toÃ n lao Ä‘á»™ng trÃªn dashboard. Káº¿t ná»‘i nhanh chÃ³ng vá»›i doanh nghiá»‡p cáº§n Ä‘Ã o táº¡o táº¡i ATLÄ Connect.">
    <meta name="keywords" content="dashboard nhu cáº§u, quáº£n lÃ½ Ä‘Ã o táº¡o, nhu cáº§u atlÄ‘, theo dÃµi yÃªu cáº§u, káº¿t ná»‘i Ä‘á»‘i tÃ¡c, doanh nghiá»‡p">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://atld.web.app/requests-dashboard.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://atld.web.app/requests-dashboard.html">
    <meta property="og:title" content="Dashboard Nhu cáº§u ÄÃ o táº¡o | Quáº£n lÃ½ yÃªu cáº§u ATLÄ">
    <meta property="og:description" content="Xem vÃ  quáº£n lÃ½ cÃ¡c nhu cáº§u Ä‘Ã o táº¡o ATLÄ. Káº¿t ná»‘i vá»›i doanh nghiá»‡p cáº§n Ä‘Ã o táº¡o an toÃ n lao Ä‘á»™ng.">
    <meta property="og:image" content="https://atld.web.app/logo.png">
    <meta property="og:locale" content="vi_VN">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Dashboard Nhu cáº§u ÄÃ o táº¡o ATLÄ">
    <meta name="twitter:description" content="Quáº£n lÃ½ vÃ  káº¿t ná»‘i vá»›i cÃ¡c nhu cáº§u Ä‘Ã o táº¡o an toÃ n lao Ä‘á»™ng.">
    <meta name="twitter:image" content="https://atld.web.app/logo.png">

    <!-- Resource Hints -->
    <link rel="preconnect" href="https://www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://www.gstatic.com">

    <!-- Google Analytics (Optimized) -->
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-Y2NK9VB75H')</script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y2NK9VB75H"></script>

    <link rel="preload" href="styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="styles.css"></noscript>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js" defer></script>

    <style>
        .dashboard-hero {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: 5rem 1rem;
        }

        .dashboard-hero h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .dashboard-hero p {
            font-size: 1.2rem;
            opacity: 0.95;
            margin-bottom: 1rem;
        }

        .dashboard-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .requests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .request-card {
            background: white;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border-top: 4px solid var(--primary-color);
            cursor: pointer;
            height: fit-content;
        }

        .request-card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transform: translateY(-4px);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-light);
        }

        .request-code {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .request-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #28A745;
            color: white;
        }

        .request-status.closed {
            background: #6C757D;
        }

        .request-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .request-info-item {
            display: flex;
            align-items: start;
            gap: 0.5rem;
        }

        .request-info-item strong {
            min-width: 120px;
            color: var(--dark-color);
        }

        .request-description {
            background: var(--light-color);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .request-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-light);
        }

        .request-stats {
            display: flex;
            gap: 1.5rem;
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        .btn-view-contact {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-view-contact:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .locked-icon {
            margin-right: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .empty-state h2 {
            color: var(--dark-color);
            margin-bottom: 1rem;
        }

        .topic-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: var(--primary-color);
            color: white;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">ATLÄ Connect</div>
            <ul class="nav-menu">
                <li><a href="index.html">Trang chá»§</a></li>
                <li><a href="courses.html">KhÃ³a há»c</a></li>
                <li><a href="documents.html">TÃ i liá»‡u</a></li>
                <li><a href="#how-it-works">CÃ¡ch thá»©c</a></li>
                <li><a href="#about">Giá»›i thiá»‡u</a></li>
                <li><a href="partner-register.html" class="btn-nav-partner">Äá»‘i tÃ¡c</a></li>
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="dashboard-hero">
        <h1>Nhu cáº§u ÄÃ o táº¡o An toÃ n Lao Ä‘á»™ng</h1>
        <p>Káº¿t ná»‘i doanh nghiá»‡p vá»›i Ä‘Æ¡n vá»‹ Ä‘Ã o táº¡o chuyÃªn nghiá»‡p</p>
        <div class="dashboard-actions">
            <a href="post-request.html" class="btn btn-large" style="background: white; color: var(--primary-color);">
                ğŸ“ ÄÄƒng tin Ä‘Ã o táº¡o
            </a>
            <a href="partner-login.html" class="btn btn-large" style="background:  white; color: var(--primary-color);">
                ğŸ” ÄÄƒng nháº­p Ä‘á»‘i tÃ¡c
            </a>
        </div>
    </section>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Filters -->
        <div class="filter-section">
            <h3 style="margin-bottom: 1rem;">Lá»c nhu cáº§u</h3>
            <div class="filter-row">
                <div class="form-group">
                    <label for="filter-topic">Chá»§ Ä‘á»</label>
                    <select id="filter-topic" class="form-control">
                        <option value="all">Táº¥t cáº£</option>
                        <option value="general">An toÃ n chung</option>
                        <option value="electrical">An toÃ n Ä‘iá»‡n</option>
                        <option value="construction">XÃ¢y dá»±ng</option>
                        <option value="fire">PCCC</option>
                        <option value="chemical">HÃ³a cháº¥t</option>
                        <option value="manufacturing">Sáº£n xuáº¥t</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-province">Tá»‰nh/ThÃ nh phá»‘</label>
                    <select id="filter-province" class="form-control">
                        <option value="all">Táº¥t cáº£</option>
                        <option value="TP. Há»“ ChÃ­ Minh">TP. Há»“ ChÃ­ Minh</option>
                        <option value="HÃ  Ná»™i">HÃ  Ná»™i</option>
                        <option value="ÄÃ  Náºµng">ÄÃ  Náºµng</option>
                        <option value="BÃ¬nh DÆ°Æ¡ng">BÃ¬nh DÆ°Æ¡ng</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-delivery">HÃ¬nh thá»©c</label>
                    <select id="filter-delivery" class="form-control">
                        <option value="all">Táº¥t cáº£</option>
                        <option value="onsite">Trá»±c tiáº¿p</option>
                        <option value="online">Online</option>
                        <option value="both">Cáº£ hai</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-status">Tráº¡ng thÃ¡i</label>
                    <select id="filter-status" class="form-control">
                        <option value="all">Táº¥t cáº£</option>
                        <option value="open">Äang má»Ÿ</option>
                        <option value="closed">ÄÃ£ Ä‘Ã³ng</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading-spinner" id="loading">Äang táº£i...</div>

        <!-- Requests List -->
        <div id="requests-list" class="requests-grid"></div>

        <!-- Empty State -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <h2>ChÆ°a cÃ³ nhu cáº§u Ä‘Ã o táº¡o nÃ o</h2>
            <p>HÃ£y lÃ  ngÆ°á»i Ä‘áº§u tiÃªn Ä‘Äƒng tin!</p>
            <a href="post-request.html" class="btn btn-primary">ÄÄƒng tin ngay</a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 ATLÄ Connect. Káº¿t ná»‘i Ä‘Ã o táº¡o An toÃ n Lao Ä‘á»™ng.</p>
        </div>
    </footer>

    <script src="firebase-config.js" defer></script>
    <script defer>
        let allRequests = [];
        let currentUser = null;

        // Setup auth listener when Firebase is ready
        function setupAuth() {
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().onAuthStateChanged((user) => {
                    currentUser = user;
                    renderRequests();
                });
            }
        }

        // Topic names
        const topicNames = {
            general: 'An toÃ n chung',
            electrical: 'An toÃ n Ä‘iá»‡n',
            construction: 'XÃ¢y dá»±ng',
            fire: 'PCCC',
            chemical: 'HÃ³a cháº¥t',
            manufacturing: 'Sáº£n xuáº¥t',
            other: 'KhÃ¡c'
        };

        const deliveryTypeNames = {
            onsite: 'Trá»±c tiáº¿p',
            online: 'Online',
            both: 'Cáº£ hai'
        };

        // Load requests
        async function loadRequests() {
            const loading = document.getElementById('loading');
            const requestsList = document.getElementById('requests-list');
            const emptyState = document.getElementById('empty-state');

            loading.style.display = 'block';
            requestsList.innerHTML = '';
            emptyState.style.display = 'none';

            try {
                console.log('ğŸ” Loading training requests...');
                const snapshot = await firebase.firestore()
                    .collection('training_requests')
                    .orderBy('createdAt', 'desc')
                    .get();

                console.log('âœ… Loaded', snapshot.size, 'requests');

                allRequests = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log('ğŸ“‹ All requests:', allRequests);
                renderRequests();
            } catch (error) {
                console.error('âŒ Error loading requests:', error);
                loading.style.display = 'none';
                emptyState.style.display = 'block';
                // Show error message to user
                requestsList.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px;">Lá»—i: ${error.message}</div>`;
            }
        }

        function renderRequests() {
            const loading = document.getElementById('loading');
            const requestsList = document.getElementById('requests-list');
            const emptyState = document.getElementById('empty-state');

            loading.style.display = 'none';

            // Apply filters
            const topicFilter = document.getElementById('filter-topic').value;
            const provinceFilter = document.getElementById('filter-province').value;
            const deliveryFilter = document.getElementById('filter-delivery').value;
            const statusFilter = document.getElementById('filter-status').value;

            const filtered = allRequests.filter(req => {
                if (topicFilter !== 'all' && req.topic !== topicFilter) return false;
                if (provinceFilter !== 'all' && req.province !== provinceFilter) return false;
                if (deliveryFilter !== 'all' && req.deliveryType !== deliveryFilter) return false;
                if (statusFilter !== 'all' && req.status !== statusFilter) return false;
                return true;
            });

            if (filtered.length === 0) {
                requestsList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            requestsList.innerHTML = '';

            filtered.forEach(req => {
                const date = req.createdAt ? new Date(req.createdAt.toDate()).toLocaleDateString('vi-VN') : 'N/A';
                const topicDisplay = req.topic === 'other' ? req.topicOther : topicNames[req.topic];
                const location = req.district ? `${req.district}, ${req.province}` : req.province;

                const card = document.createElement('div');
                card.className = 'request-card';
                card.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.85rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem;">${req.requestCode}</div>
                        <div style="font-size: 1rem; font-weight: 600; color: var(--dark-color); margin-bottom: 0.5rem;">${topicDisplay}</div>
                        <span class="request-status ${req.status}" style="font-size: 0.75rem;">${req.status === 'open' ? 'ğŸŸ¢ Äang má»Ÿ' : 'âš« ÄÃ£ Ä‘Ã³ng'}</span>
                    </div>

                    <div style="font-size: 0.9rem; color: var(--gray-color); margin-bottom: 1rem; line-height: 1.6;">
                        <div style="margin-bottom: 0.4rem;">ğŸ“ ${location}</div>
                        <div style="margin-bottom: 0.4rem;">ğŸ“š ${deliveryTypeNames[req.deliveryType]}</div>
                        <div style="margin-bottom: 0.4rem;">ğŸ‘¥ ${req.numTrainees} há»c viÃªn</div>
                        <div style="margin-bottom: 0.4rem;">ğŸ’° ${req.budget} ${req.budget !== 'Trao Ä‘á»•i sau' ? 'triá»‡u' : ''}</div>
                        <div style="margin-bottom: 0.4rem;">ğŸ“… ${date}</div>
                    </div>

                    <div style="background: var(--light-color); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.85rem; line-height: 1.5; max-height: 80px; overflow: hidden;">
                        ${req.description.substring(0, 100)}${req.description.length > 100 ? '...' : ''}
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--gray-color); margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-light);">
                        <span>ğŸ‘ï¸ ${req.viewCount || 0}</span>
                        <span>ğŸ“ ${req.contactCount || 0}</span>
                    </div>

                    <button class="btn btn-primary" onclick="event.stopPropagation(); viewContact('${req.id}')" style="width: 100%; padding: 0.65rem; font-size: 0.9rem; font-weight: 600; border-radius: 8px;">
                        ğŸ”’ Xem thÃ´ng tin liÃªn há»‡
                    </button>
                `;
                requestsList.appendChild(card);
            });
        }

        // View contact - requires login
        window.viewContact = async function(requestId) {
            if (!currentUser) {
                alert('Báº¡n cáº§n Ä‘Äƒng nháº­p vá»›i tÃ i khoáº£n Ä‘á»‘i tÃ¡c Ä‘á»ƒ xem thÃ´ng tin liÃªn há»‡.');
                window.location.href = 'partner-login.html?redirect=requests-dashboard.html';
                return;
            }

            // Redirect to partner dashboard with request ID
            window.location.href = `partner-dashboard.html?requestId=${requestId}`;
        };

        // Filter change handlers
        document.getElementById('filter-topic').addEventListener('change', renderRequests);
        document.getElementById('filter-province').addEventListener('change', renderRequests);
        document.getElementById('filter-delivery').addEventListener('change', renderRequests);
        document.getElementById('filter-status').addEventListener('change', renderRequests);

        // Wait for Firebase to load before initial load
        function initDashboard() {
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                console.log('âœ… Firebase ready, initializing dashboard...');
                setupAuth();
                loadRequests();
            } else {
                // Retry after 100ms if Firebase not ready
                setTimeout(initDashboard, 100);
            }
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDashboard);
        } else {
            initDashboard();
        }
    </script>
</body>
</html>
