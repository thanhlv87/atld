<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Email - ATLÄ Connect</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 4rem auto;
            padding: 2rem;
        }
        .test-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .result-box {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success-box {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .error-box {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="test-container">
        <h1 style="color: var(--primary-color); margin-bottom: 1rem;">ğŸ§ª Test Email Notification</h1>
        <p style="color: var(--gray-color); margin-bottom: 2rem;">Trang nÃ y dÃ¹ng Ä‘á»ƒ test tÃ­nh nÄƒng gá»­i email thÃ´ng bÃ¡o</p>

        <!-- Test 1: Simple Email -->
        <div class="test-card">
            <h2>ğŸ“§ Test 1: Gá»­i Email ÄÆ¡n Giáº£n</h2>
            <p style="color: var(--gray-color); margin-bottom: 1rem;">
                Gá»­i má»™t email test Ä‘Æ¡n giáº£n Ä‘á»ƒ kiá»ƒm tra Firebase Extension hoáº¡t Ä‘á»™ng
            </p>

            <div class="form-group">
                <label class="form-label">Email nháº­n test:</label>
                <input type="email" id="test1-email" class="form-control"
                    value="vietthanh228@gmail.com"
                    placeholder="email@example.com">
            </div>

            <button class="btn btn-primary" onclick="testSimpleEmail()">
                ğŸ“¨ Gá»­i Email Test
            </button>

            <div id="test1-result"></div>
        </div>

        <!-- Test 2: Training Request Email -->
        <div class="test-card">
            <h2>ğŸ“ Test 2: Gá»­i Email YÃªu Cáº§u ÄÃ o Táº¡o</h2>
            <p style="color: var(--gray-color); margin-bottom: 1rem;">
                Gá»­i email vá»›i template Ä‘áº§y Ä‘á»§ nhÆ° khi cÃ³ yÃªu cáº§u Ä‘Ã o táº¡o má»›i
            </p>

            <div class="form-group">
                <label class="form-label">Email nháº­n test:</label>
                <input type="email" id="test2-email" class="form-control"
                    value="vietthanh228@gmail.com"
                    placeholder="email@example.com">
            </div>

            <button class="btn btn-primary" onclick="testTrainingRequestEmail()">
                ğŸ“¨ Gá»­i Email Template Äáº§y Äá»§
            </button>

            <div id="test2-result"></div>
        </div>

        <!-- Test 3: Get All Notification Emails -->
        <div class="test-card">
            <h2>ğŸ“‹ Test 3: Kiá»ƒm Tra Danh SÃ¡ch Email</h2>
            <p style="color: var(--gray-color); margin-bottom: 1rem;">
                Xem táº¥t cáº£ email sáº½ nháº­n thÃ´ng bÃ¡o (tá»« partners + manual)
            </p>

            <button class="btn btn-secondary" onclick="testGetAllEmails()">
                ğŸ“Š Xem Danh SÃ¡ch Email
            </button>

            <div id="test3-result"></div>
        </div>

        <!-- Test 4: Check Mail Collection -->
        <div class="test-card">
            <h2>ğŸ” Test 4: Kiá»ƒm Tra Collection Mail</h2>
            <p style="color: var(--gray-color); margin-bottom: 1rem;">
                Xem cÃ¡c email Ä‘Ã£ Ä‘Æ°á»£c gá»­i (hoáº·c Ä‘ang chá» gá»­i) trong collection 'mail'
            </p>

            <button class="btn btn-secondary" onclick="testCheckMailCollection()">
                ğŸ—‚ï¸ Xem Mail Queue
            </button>

            <div id="test4-result"></div>
        </div>

        <div style="background: #fff3cd; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #ffc107;">
            <h3>ğŸ’¡ LÆ°u Ã½:</h3>
            <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
                <li>Email sáº½ Ä‘Æ°á»£c gá»­i sau 10-30 giÃ¢y</li>
                <li>Kiá»ƒm tra cáº£ thÆ° má»¥c Spam náº¿u khÃ´ng tháº¥y email</li>
                <li>Xem logs táº¡i: <a href="https://console.firebase.google.com/project/gen-lang-client-0113063590/extensions/instances/firestore-send-email-idul" target="_blank">Extension Logs</a></li>
                <li>Extension pháº£i Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘Ãºng SMTP password</li>
            </ul>
        </div>

        <div style="margin-top: 2rem; text-align: center;">
            <a href="admin-partners.html" class="btn btn-secondary">â† Quay láº¡i Admin</a>
            <a href="post-request.html" class="btn btn-primary" style="margin-left: 1rem;">Äáº¿n Trang ÄÄƒng Tin â†’</a>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        // Test 1: Simple Email
        async function testSimpleEmail() {
            const email = document.getElementById('test1-email').value.trim();
            const resultDiv = document.getElementById('test1-result');

            if (!email) {
                alert('Vui lÃ²ng nháº­p email!');
                return;
            }

            resultDiv.innerHTML = '<div class="result-box">â³ Äang gá»­i email...</div>';

            try {
                const docRef = await firebase.firestore().collection('mail').add({
                    to: [email],
                    message: {
                        subject: 'ğŸ§ª Test Email - ATLÄ Connect',
                        html: `
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="UTF-8">
                            </head>
                            <body style="font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5;">
                                <div style="max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px;">
                                    <h1 style="color: #dc2626;">ğŸ§ª Test Email ThÃ nh CÃ´ng!</h1>
                                    <p>ChÃ o báº¡n,</p>
                                    <p>ÄÃ¢y lÃ  email test tá»« há»‡ thá»‘ng <strong>ATLÄ Connect</strong>.</p>
                                    <p>Náº¿u báº¡n nháº­n Ä‘Æ°á»£c email nÃ y, nghÄ©a lÃ  Firebase Extension <strong>Trigger Email</strong> Ä‘Ã£ hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng!</p>
                                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                                    <p style="font-size: 12px; color: #666;">
                                        Email Ä‘Æ°á»£c gá»­i lÃºc: ${new Date().toLocaleString('vi-VN')}<br>
                                        Tá»«: ATLÄ Connect System
                                    </p>
                                </div>
                            </body>
                            </html>
                        `
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                resultDiv.innerHTML = `
                    <div class="result-box success-box">
                        âœ… <strong>ThÃ nh cÃ´ng!</strong><br><br>
                        Document ID: ${docRef.id}<br>
                        Email sáº½ Ä‘Æ°á»£c gá»­i Ä‘áº¿n: ${email}<br>
                        Thá»i gian: ${new Date().toLocaleString('vi-VN')}<br><br>
                        â³ Äá»£i 10-30 giÃ¢y rá»“i kiá»ƒm tra inbox/spam cá»§a báº¡n
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result-box error-box">
                        âŒ <strong>Lá»—i!</strong><br><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Test 2: Training Request Email
        async function testTrainingRequestEmail() {
            const email = document.getElementById('test2-email').value.trim();
            const resultDiv = document.getElementById('test2-result');

            if (!email) {
                alert('Vui lÃ²ng nháº­p email!');
                return;
            }

            resultDiv.innerHTML = '<div class="result-box">â³ Äang gá»­i email...</div>';

            const mockRequestData = {
                topic: 'fire',
                topicOther: '',
                numTrainees: '50',
                province: 'TP. Há»“ ChÃ­ Minh',
                district: 'Quáº­n 1',
                deliveryType: 'onsite',
                timeframe: 'Trong 1 thÃ¡ng',
                budget: '20-30 triá»‡u',
                description: 'Cáº§n Ä‘Ã o táº¡o phÃ²ng chÃ¡y chá»¯a chÃ¡y cho 50 nhÃ¢n viÃªn vÄƒn phÃ²ng'
            };

            const requestCode = 'TEST' + Date.now();
            const topicNames = {
                'fire': 'PhÃ²ng chÃ¡y chá»¯a chÃ¡y',
                'general': 'An toÃ n lao Ä‘á»™ng chung',
                'electrical': 'An toÃ n Ä‘iá»‡n',
                'construction': 'An toÃ n xÃ¢y dá»±ng'
            };

            try {
                const docRef = await firebase.firestore().collection('mail').add({
                    to: [email],
                    message: {
                        subject: `ğŸ”” [TEST] YÃªu cáº§u Ä‘Ã o táº¡o má»›i - ${topicNames[mockRequestData.topic]}`,
                        html: `
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="UTF-8">
                                <style>
                                    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                                    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                                    .header { background: linear-gradient(135deg, #dc2626, #991b1b); color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
                                    .content { background: #f9f9f9; padding: 20px; border: 1px solid #ddd; }
                                    .info-row { margin: 10px 0; padding: 10px; background: white; border-left: 4px solid #dc2626; }
                                    .label { font-weight: bold; color: #dc2626; }
                                    .cta-button { display: inline-block; padding: 12px 24px; background: #dc2626; color: white; text-decoration: none; border-radius: 6px; margin: 20px 0; }
                                    .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
                                    .test-banner { background: #ffc107; color: #000; padding: 10px; text-align: center; font-weight: bold; }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <div class="test-banner">
                                        ğŸ§ª ÄÃ‚Y LÃ€ EMAIL TEST - KHÃ”NG PHáº¢I YÃŠU Cáº¦U THáº¬T
                                    </div>
                                    <div class="header">
                                        <h1 style="margin: 0;">ğŸ”” YÃŠU Cáº¦U ÄÃ€O Táº O Má»šI</h1>
                                        <p style="margin: 10px 0 0 0;">ATLÄ Connect</p>
                                    </div>
                                    <div class="content">
                                        <p>Xin chÃ o Äá»‘i tÃ¡c,</p>
                                        <p>CÃ³ má»™t yÃªu cáº§u Ä‘Ã o táº¡o má»›i phÃ¹ há»£p vá»›i lÄ©nh vá»±c cá»§a báº¡n:</p>

                                        <div class="info-row">
                                            <span class="label">ğŸ“ MÃ£ yÃªu cáº§u:</span> ${requestCode}
                                        </div>
                                        <div class="info-row">
                                            <span class="label">ğŸ“š Chá»§ Ä‘á»:</span> ${topicNames[mockRequestData.topic]}
                                        </div>
                                        <div class="info-row">
                                            <span class="label">ğŸ‘¥ Sá»‘ há»c viÃªn:</span> ${mockRequestData.numTrainees} ngÆ°á»i
                                        </div>
                                        <div class="info-row">
                                            <span class="label">ğŸ“ Äá»‹a Ä‘iá»ƒm:</span> ${mockRequestData.province}, ${mockRequestData.district}
                                        </div>
                                        <div class="info-row">
                                            <span class="label">ğŸ“ HÃ¬nh thá»©c:</span> Trá»±c tiáº¿p táº¡i Ä‘á»‹a Ä‘iá»ƒm
                                        </div>
                                        <div class="info-row">
                                            <span class="label">â° Thá»i gian:</span> ${mockRequestData.timeframe}
                                        </div>
                                        <div class="info-row">
                                            <span class="label">ğŸ’° NgÃ¢n sÃ¡ch:</span> ${mockRequestData.budget}
                                        </div>
                                        <div class="info-row">
                                            <span class="label">ğŸ“‹ MÃ´ táº£:</span><br>
                                            ${mockRequestData.description}
                                        </div>

                                        <div style="text-align: center;">
                                            <a href="https://atld.web.app/requests-dashboard.html" class="cta-button">
                                                ğŸ‘ï¸ Xem chi tiáº¿t vÃ  LiÃªn há»‡
                                            </a>
                                        </div>

                                        <p style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                                            <strong>ğŸ’¡ LÆ°u Ã½:</strong> ÄÃ¢y lÃ  cÆ¡ há»™i káº¿t ná»‘i vá»›i khÃ¡ch hÃ ng tiá»m nÄƒng.
                                            HÃ£y truy cáº­p Dashboard Ä‘á»ƒ xem thÃ´ng tin liÃªn há»‡ vÃ  gá»­i bÃ¡o giÃ¡!
                                        </p>
                                    </div>
                                    <div class="footer">
                                        <p>Email nÃ y Ä‘Æ°á»£c gá»­i tá»± Ä‘á»™ng tá»« há»‡ thá»‘ng ATLÄ Connect</p>
                                        <p>Â© 2025 ATLÄ Connect. All rights reserved.</p>
                                        <p>
                                            <a href="https://atld.web.app" style="color: #dc2626;">atld.web.app</a> |
                                            <a href="mailto:vietthanh228@gmail.com" style="color: #dc2626;">vietthanh228@gmail.com</a>
                                        </p>
                                    </div>
                                </div>
                            </body>
                            </html>
                        `
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    requestCode: requestCode
                });

                resultDiv.innerHTML = `
                    <div class="result-box success-box">
                        âœ… <strong>ThÃ nh cÃ´ng!</strong><br><br>
                        Document ID: ${docRef.id}<br>
                        Request Code: ${requestCode}<br>
                        Email sáº½ Ä‘Æ°á»£c gá»­i Ä‘áº¿n: ${email}<br>
                        Thá»i gian: ${new Date().toLocaleString('vi-VN')}<br><br>
                        â³ Äá»£i 10-30 giÃ¢y rá»“i kiá»ƒm tra inbox/spam cá»§a báº¡n<br>
                        ğŸ“§ Email sáº½ cÃ³ Ä‘áº§y Ä‘á»§ template nhÆ° yÃªu cáº§u Ä‘Ã o táº¡o tháº­t
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result-box error-box">
                        âŒ <strong>Lá»—i!</strong><br><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Test 3: Get All Emails
        async function testGetAllEmails() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.innerHTML = '<div class="result-box">â³ Äang táº£i danh sÃ¡ch...</div>';

            try {
                // Get manual emails
                const manualSnapshot = await firebase.firestore()
                    .collection('notificationEmails')
                    .get();

                const manualEmails = manualSnapshot.docs.map(doc => doc.data().email);

                // Get partner emails
                const partnersSnapshot = await firebase.firestore()
                    .collection('partners')
                    .where('status', '==', 'approved')
                    .where('subscriptionStatus', '==', 'active')
                    .get();

                const partnerEmails = partnersSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return `${data.email} (${data.companyName})`;
                });

                // Combine
                const allEmails = [...new Set([...manualEmails, ...partnerEmails.map(e => e.split(' ')[0])])];

                resultDiv.innerHTML = `
                    <div class="result-box success-box">
                        <strong>ğŸ“§ Tá»•ng sá»‘ email: ${allEmails.length}</strong><br><br>

                        <strong>âœï¸ Email thá»§ cÃ´ng (${manualEmails.length}):</strong><br>
                        ${manualEmails.length > 0 ? manualEmails.join('<br>') : '<em>ChÆ°a cÃ³</em>'}<br><br>

                        <strong>ğŸ¢ Email tá»« Ä‘á»‘i tÃ¡c (${partnerEmails.length}):</strong><br>
                        ${partnerEmails.length > 0 ? partnerEmails.join('<br>') : '<em>ChÆ°a cÃ³ Ä‘á»‘i tÃ¡c active</em>'}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result-box error-box">
                        âŒ <strong>Lá»—i!</strong><br><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Test 4: Check Mail Collection
        async function testCheckMailCollection() {
            const resultDiv = document.getElementById('test4-result');
            resultDiv.innerHTML = '<div class="result-box">â³ Äang kiá»ƒm tra...</div>';

            try {
                const snapshot = await firebase.firestore()
                    .collection('mail')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();

                if (snapshot.empty) {
                    resultDiv.innerHTML = `
                        <div class="result-box">
                            â„¹ï¸ <strong>ChÆ°a cÃ³ email nÃ o trong queue</strong><br><br>
                            Collection 'mail' Ä‘ang trá»‘ng. HÃ£y thá»­ gá»­i email test á»Ÿ trÃªn!
                        </div>
                    `;
                    return;
                }

                let html = '<div class="result-box success-box">';
                html += `<strong>ğŸ“§ ${snapshot.size} email gáº§n nháº¥t:</strong><br><br>`;

                snapshot.docs.forEach((doc, index) => {
                    const data = doc.data();
                    const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleString('vi-VN') : 'N/A';
                    const deliveryState = data.delivery?.state || 'PENDING';
                    const deliveryError = data.delivery?.error || '';

                    html += `<strong>${index + 1}. Document ID:</strong> ${doc.id}<br>`;
                    html += `   <strong>To:</strong> ${Array.isArray(data.to) ? data.to.join(', ') : data.to}<br>`;
                    html += `   <strong>Subject:</strong> ${data.message?.subject || 'N/A'}<br>`;
                    html += `   <strong>Status:</strong> ${deliveryState}<br>`;
                    if (deliveryError) html += `   <strong>Error:</strong> ${deliveryError}<br>`;
                    html += `   <strong>Created:</strong> ${time}<br><br>`;
                });

                html += '</div>';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result-box error-box">
                        âŒ <strong>Lá»—i!</strong><br><br>
                        ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
